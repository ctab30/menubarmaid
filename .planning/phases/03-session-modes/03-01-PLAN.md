---
phase: 03-session-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/sessions.js, main.js, src/preload.js]
autonomous: true
---

<objective>
Add backend support for dangerous mode sessions and persistent mode preferences per pinned path.

Purpose: Enable sessions to run with `--dangerously-skip-permissions` flag and remember preferences.
Output: SessionManager accepts mode flag, IPC handlers for mode management, preferences stored per path.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/sessions.js
@main.js
@src/preload.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dangerous mode support to SessionManager</name>
  <files>src/sessions.js</files>
  <action>
Modify createSession to accept an options object with `dangerousMode` flag.

1. Update createSession signature:
```javascript
createSession(cwd = os.homedir(), options = {}) {
    const { dangerousMode = false } = options;
```

2. Modify the claude command to include flag when dangerousMode is true:
```javascript
// In the prompt detection callback:
if (!claudeLaunched && /[$%>#]\s*$/.test(outputBuffer)) {
    claudeLaunched = true;
    setTimeout(() => {
        const claudeCmd = dangerousMode
            ? 'claude --dangerously-skip-permissions\r'
            : 'claude\r';
        ptyProcess.write(claudeCmd);
    }, 50);
}
```

3. Store dangerousMode in the session object for later retrieval:
```javascript
const session = {
    id,
    pid: ptyProcess.pid,
    cwd,
    dangerousMode,  // Add this
    ptyProcess,
    // ...
};
```

4. Include dangerousMode in getSession and getAllSessions return values.
  </action>
  <verify>
Manually test by modifying test code or checking that the method accepts options.
Code review: createSession accepts { dangerousMode } option and includes it in session data.
  </verify>
  <done>SessionManager.createSession accepts dangerousMode option and launches claude with appropriate flag</done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers for mode preferences</name>
  <files>main.js, src/preload.js</files>
  <action>
Add IPC handlers for storing and retrieving mode preferences per path.

1. In main.js, add new IPC handlers after pins handlers:

```javascript
// Mode preferences (stored per path)
ipcMain.handle('modes:get', async (event, pathKey) => {
    try {
        const modes = store.get('pathModes', {});
        return { success: true, data: modes[pathKey] || { dangerousMode: false } };
    } catch (error) {
        console.error('modes:get error:', error);
        return { success: false, error: error.message };
    }
});

ipcMain.handle('modes:set', async (event, pathKey, mode) => {
    try {
        const modes = store.get('pathModes', {});
        modes[pathKey] = mode;
        store.set('pathModes', modes);
        return { success: true, data: mode };
    } catch (error) {
        console.error('modes:set error:', error);
        return { success: false, error: error.message };
    }
});
```

2. Update sessions:create IPC handler to accept options:

```javascript
ipcMain.handle('sessions:create', async (event, cwd, options = {}) => {
    try {
        return { success: true, data: sessionManager.createSession(cwd, options) };
    } catch (error) {
        console.error('sessions:create error:', error);
        return { success: false, error: error.message };
    }
});
```

3. In src/preload.js, expose new APIs in contextBridge:

```javascript
// Add to sessions object:
createSession: (cwd, options) => ipcRenderer.invoke('sessions:create', cwd, options),

// Add new modes object:
modes: {
    get: (pathKey) => ipcRenderer.invoke('modes:get', pathKey),
    set: (pathKey, mode) => ipcRenderer.invoke('modes:set', pathKey, mode),
},
```
  </action>
  <verify>Check preload.js exposes modes API. Check main.js has modes:get and modes:set handlers.</verify>
  <done>IPC handlers for mode preferences added, preload exposes modes API</done>
</task>

<task type="auto">
  <name>Task 3: Include mode in session data returned to renderer</name>
  <files>src/sessions.js</files>
  <action>
Ensure getSession and getAllSessions include dangerousMode in returned data.

1. Update getSession return:
```javascript
getSession(id) {
    this.validateSessionId(id);
    const session = this.sessions.get(id);

    return {
        id: session.id,
        cwd: session.cwd,
        pid: session.pid,
        dangerousMode: session.dangerousMode,  // Add this
        createdAt: session.createdAt,
        lastActivity: session.lastActivity,
        recentOutput: session.outputBuffer.slice(-50).join('\n')
    };
}
```

2. Update getAllSessions return in the map:
```javascript
getAllSessions() {
    return Array.from(this.sessions.values()).map(session => ({
        id: session.id,
        cwd: session.cwd,
        pid: session.pid,
        dangerousMode: session.dangerousMode,  // Add this
        createdAt: session.createdAt,
        lastActivity: session.lastActivity,
        preview: this.getPreviewLines(session, 4)
    }));
}
```
  </action>
  <verify>Code review confirms dangerousMode is included in both getSession and getAllSessions return values</verify>
  <done>Session data includes dangerousMode flag for renderer consumption</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] createSession accepts { dangerousMode } option
- [ ] Claude launches with --dangerously-skip-permissions when dangerousMode is true
- [ ] modes:get and modes:set IPC handlers exist
- [ ] preload.js exposes window.api.modes
- [ ] getSession and getAllSessions return dangerousMode
</verification>

<success_criteria>
- All tasks completed
- Backend fully supports dangerous mode sessions
- Mode preferences can be stored and retrieved per path
- Session data includes mode information
</success_criteria>

<output>
After completion, create `.planning/phases/03-session-modes/03-01-SUMMARY.md`
</output>
