---
phase: 03-session-modes
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [views/index.html, views/css/style.css, views/js/renderer.js]
autonomous: true
---

<objective>
Add UI toggle for dangerous mode and visual indicator showing current session mode.

Purpose: Allow users to toggle dangerous mode with clear visual feedback about current state.
Output: Toggle switch in terminal bar, mode indicator, session cards show mode status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-session-modes/03-01-SUMMARY.md
@views/index.html
@views/css/style.css
@views/js/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode toggle UI to terminal bar</name>
  <files>views/index.html</files>
  <action>
Add a mode toggle switch to the terminal bar between the terminal-info and btn-pin.

Structure:
```html
<!-- Mode Toggle -->
<div class="mode-toggle" title="Toggle dangerous mode">
    <label class="toggle-switch">
        <input type="checkbox" id="mode-toggle-input">
        <span class="toggle-slider"></span>
    </label>
    <span class="mode-label" id="mode-label">Safe</span>
</div>
```

Place this after terminal-info div and before btn-pin button in the terminal-bar.

The toggle shows:
- Unchecked (default): Safe mode
- Checked: Dangerous mode (--dangerously-skip-permissions)
  </action>
  <verify>Open views/index.html and confirm mode-toggle element exists in terminal-bar</verify>
  <done>Mode toggle HTML structure added to terminal bar</done>
</task>

<task type="auto">
  <name>Task 2: Style mode toggle with iOS design</name>
  <files>views/css/style.css</files>
  <action>
Add CSS for iOS-style toggle switch.

```css
/* ============================================
   Mode Toggle
   ============================================ */

.mode-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 8px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    transition: background-color var(--duration-fast) var(--ease-out-quart);
}

.toggle-slider::before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: transform var(--duration-fast) var(--ease-spring);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Checked state - dangerous mode */
.toggle-switch input:checked + .toggle-slider {
    background-color: var(--orange);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

/* Mode label */
.mode-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    min-width: 60px;
    transition: color var(--duration-fast) var(--ease-out-quart);
}

.mode-label.dangerous {
    color: var(--orange);
}

/* Mode indicator in session cards */
.session-card.dangerous-mode .session-status {
    background: var(--orange);
    box-shadow: 0 0 6px var(--orange);
    animation: none;
}

.session-card.dangerous-mode .session-name::after {
    content: " âš ";
    color: var(--orange);
    font-size: 10px;
}
```

The toggle uses orange color (var(--orange)) for dangerous mode to indicate caution.
  </action>
  <verify>npm start and visually confirm toggle switch renders with iOS-style appearance</verify>
  <done>Mode toggle styled with iOS design, orange for dangerous mode</done>
</task>

<task type="auto">
  <name>Task 3: Implement mode toggle logic and session restart</name>
  <files>views/js/renderer.js</files>
  <action>
Implement the mode toggle behavior:

1. Add mode state tracking at top of file:
```javascript
let currentSessionDangerousMode = false;
```

2. Add mode toggle elements to DOM references:
```javascript
const modeToggleInput = document.getElementById('mode-toggle-input');
const modeLabel = document.getElementById('mode-label');
```

3. Add event listener in setupEventListeners():
```javascript
modeToggleInput.addEventListener('change', handleModeToggle);
```

4. Create handleModeToggle function:
```javascript
async function handleModeToggle() {
    if (!currentSessionId || !currentSessionPath) return;

    const newDangerousMode = modeToggleInput.checked;

    // Save preference for this path
    await window.api.modes.set(currentSessionPath, { dangerousMode: newDangerousMode });

    // Update label
    updateModeLabel(newDangerousMode);

    // Kill current session and restart with new mode
    await window.api.killSession(currentSessionId);

    // Start new session with the mode preference
    const result = await window.api.createSession(currentSessionPath, { dangerousMode: newDangerousMode });
    const session = unwrap(result);
    if (session) {
        await refreshAll();
        showTerminalView(session.id);
    }
}

function updateModeLabel(dangerousMode) {
    if (dangerousMode) {
        modeLabel.textContent = 'Dangerous';
        modeLabel.classList.add('dangerous');
    } else {
        modeLabel.textContent = 'Safe';
        modeLabel.classList.remove('dangerous');
    }
    currentSessionDangerousMode = dangerousMode;
}
```

5. Update showTerminalView to load mode preference:
```javascript
// After getting session, load mode preference and update toggle:
const modeResult = await window.api.modes.get(session.cwd);
const modeData = unwrap(modeResult) || { dangerousMode: false };
modeToggleInput.checked = session.dangerousMode || modeData.dangerousMode;
updateModeLabel(session.dangerousMode || modeData.dangerousMode);
```

6. Update startSessionAtPath to use stored mode preference:
```javascript
async function startSessionAtPath(folder) {
    // Load mode preference for this path
    const modeResult = await window.api.modes.get(folder);
    const modeData = unwrap(modeResult) || { dangerousMode: false };

    const result = await window.api.createSession(folder, { dangerousMode: modeData.dangerousMode });
    const session = unwrap(result);
    if (!session) return;
    await refreshAll();
    showTerminalView(session.id);
}
```

7. Update createSessionCard to show dangerous mode indicator:
```javascript
// In createSessionCard, add class if dangerous mode:
if (session.dangerousMode) {
    card.classList.add('dangerous-mode');
}
```
  </action>
  <verify>
1. npm start
2. Create a session
3. Toggle dangerous mode switch
4. Verify: Session restarts, label updates, preference is saved
5. Close and reopen session - mode preference should be remembered
  </verify>
  <done>Mode toggle fully functional with session restart and preference persistence</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Mode toggle visible in terminal bar
- [ ] Toggle has iOS-style appearance
- [ ] Toggling restarts session with new mode
- [ ] Mode label shows "Safe" or "Dangerous"
- [ ] Mode preference persists for each path
- [ ] Session cards show dangerous mode indicator
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- Users can toggle dangerous mode with visual feedback
- Sessions restart with appropriate flag when mode changes
- Mode preferences persist across sessions
- Clear visual indicators show current mode
</success_criteria>

<output>
After completion, create `.planning/phases/03-session-modes/03-02-SUMMARY.md`
</output>
